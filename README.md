# Mage-tools

Mage-tools is an opinionated set of [mage](https://github.com/magefile/mage) targets to help with build automation of different projects

[![Release](https://github.com/einride/mage-tools/actions/workflows/release.yml/badge.svg)](https://github.com/einride/mage-tools/actions/workflows/release.yml)

## Requirements

- [Go](https://golang.org/doc/install) >= 1.17
- [GNU Make](https://www.gnu.org/software/make/)

## Getting started

To initilize mage-tools in a repository, just run:

```bash
go run go.einride.tech/mage-tools@latest init
```

Run `make`

## Usage

All mage imports, and targets within the magefiles, gets written to a default Makefile which is always imported. It can also generate specific makefiles to only be imported in certain places like in a Makefile that should only have terraform targets.

### Magefiles

You can have as many magefiles as you want in the `.mage` folder, as long as you tag them and put them in the main package

```golang
// +build mage

package main
```

#### Imports

If you want to import targets from this repository, just import and add the `// mage:import` comment above the import and alias it with `_` if its only to be used as a mage target

```golang
// mage:import
"go.einride.tech/mage-tools/targets/mggo"

// mage:import
_ "go.einride.tech/mage-tools/targets/mgsemanticrelease"
```

#### Local targets

If you wish to utilize an import, or define your own target; like an `All` target, you can just write one yourself. Just create a public function in a magefile, and it will be included. The target can have no return value other then error.

```golang
func All() {
	mg.Deps(
		mg.F(mgcommitlint.Commitlint, "main"),
	)
	mg.SerialDeps(
		mggitverifynodiff.GitVerifyNoDiff,
	)
}
```

#### Specific makefiles / Mage namespaces

We utilize mage namespaces to group targets and write them to unique Makefiles. This can be done via import or for local targets. The below would generate a `semantic-release.mk` and a `terraform.mk`

```golang
import (
	// mage:import semantic-release
	_ "go.einride.tech/mage-tools/semantic-release"
)

type Terraform mg.Namespace

func (Terraform) TerraformInitDev() {
	mg.SerialDeps(
		Terraform.devConfig,
		mgterraform.Init,
	)
}
```

Which we can then import like below, where the `$(mage_terraform)` variable gets generated by the tooling

```Makefile
include ./.mage/tools.mk
include $(mage_terraform)
```

#### Dependencies

Dependencies can be defined just by specificing the function, or with `mg.F` if the function takes arguments. `Deps` runs in parallel while `Serial` runs serially

```golang
mg.Deps(
	mg.F(mgcommitlint.Commitlint, "main"),
	mggolangcilint.GolangciLint,
	mggoreview.Goreview,
)
mg.SerialDeps(
	mggo.GoModTidy,
	mggitverifynodiff.GitVerifyNoDiff,
)
```
